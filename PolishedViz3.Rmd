---
title: "ENVS3100PolViz3"
author: "Brett Chelf"
date: "`r Sys.Date()`"
output: html_document
theme:
---

# Setting Up my Environment and Data
I wanted to challenge myself to start working with geospatial data after seeing some other people make simple maps in this class. I work with ArcGIS for other classes so I wanted to see how I can manipulate the same file types using R. I found a really cool data set on Kaggle that provides observations of a ton of different species using logs from iNaturalist. I want to plot this in a way that seems meaningful.

My data came from: https://www.kaggle.com/datasets/travisdaws/spatiotemporal-wildlife-dataset/data
```{r setup, include=TRUE}
setwd('/Users/bgche/Documents/R Workspaces/VizPracticeDirectory')
library(tidyr)
library(dplyr)
library(leaflet)
library(mapview)
library(tmap)
library(sf)
library(spData)
library(ggplot2)
library(readr)
library(RColorBrewer)
wildlifedata <- readr::read_csv('observations_mammalia_global.csv')
head(wildlifedata)
```

# Data Wrangling and Exploration
Now that I have everything I need loaded in, I want to look at the data frame more in-depth and clean it for my purposes. The file is hugeeeee, and R does not like to use that much working memory. By choosing specific columns and limiting myself to a small geographic location (I chose New Zealand), I can work more easily with smaller data frames. I also have to convert the entries into simple features using the coordinates provided, so that sf will recognize them as points in space that I can plot.

```{r, data wrangling}
library(spData)
regions_nz <- nz
wld <- wildlifedata[c("id","latitude","longitude","scientific_name","common_name","observed_on")]
wld_filtered <- wld %>%
  filter(!grepl("Domestic|European", common_name, ignore.case = TRUE))

observations_sf <- st_as_sf(
  wld_filtered, coords = c("longitude", "latitude"), crs = 4326
)
st_crs(observations_sf)
st_crs(regions_nz)
observations_sf <- st_transform(observations_sf, st_crs(regions_nz))
filtered_points <- st_join(observations_sf, regions_nz, join = st_within, left = FALSE)
nz_buffer <- st_buffer(regions_nz, dist = 0.25)
near_points <- st_filter(observations_sf, nz_buffer)
```
# Environment for Building the Graphic
I want to show all the observations of species (not domestic or introduced from Europe) within New Zealand. Mapview is a simple tool that can make me a map with very little code so I'll start with that.

```{r mapping}
library(mapview)
mapview(regions_nz, alpha.regions = 0.2, legend = TRUE) +
  mapview(filtered_points, zcol = "common_name", legend = TRUE, popup = NULL)
```

# New Direction
Wow. This visualization is really impressive but it doesn't display the data in a useful way in my opinion. Also, it's very limited and lacks professional polish. I need to get even more specific, and use something more sophisticated. My new idea is to create an interactive heatmap which will color the regions of New Zealand by the number of species observed in them, and then display a pop-up which will give a detailed breakdown of the species in that area.I will use tmap to do this, because leaflet has been tricky in my own tinkering. First, I need to make changes to my data again. These different variables/dfs are starting to get out of control and hard to manage. In the future I would probably use a more careful naming system.
```{r data wrangling 2}
observations_with_region <- st_join(filtered_points, regions_nz, join = st_within)
region_summary <- observations_with_region %>%
  group_by(Name.x) %>%
  summarise(
    total_obs = n(),
    species_richness = n_distinct(common_name),
    species_count = list(table(common_name))
  )
regions_df <- st_set_geometry(regions_nz, NULL) 
region_summary_df <- as.data.frame(region_summary) 
region_summary_df <- region_summary_df %>%
  rename(Name = Name.x)
merged_df <- left_join(regions_df, region_summary_df, by = 'Name')
regions_nz_summary <- st_as_sf(merged_df)
st_geometry(regions_nz_summary) <- regions_nz$geom
regions_nz_summary$species_popup <- sapply(regions_nz_summary$species_count, function(sp_table) {
  paste(names(sp_table), sp_table, sep = ": ", collapse = "<br>")
})
regions_nz_summary$popup_content <- paste0(
  "<b>Region: </b>", regions_nz_summary$Name, "<br>",
  "<b>Total observations: </b>", regions_nz_summary$total_obs, "<br>",
  "<b>Species richness: </b>", regions_nz_summary$species_richness, "<br><br>",
  "<b>Species counts:</b><br>",
  sapply(regions_nz_summary$species_count, function(sp_table) {
    paste(names(sp_table), sp_table, sep = ": ", collapse = "<br>")
  })
)
```

```{r heatmap}

library(stringr)
regions_nz_summary$species_popup <- sapply(regions_nz_summary$species_count, function(sp_table) {
  paste(names(sp_table), sp_table, sep = ": ", collapse = "<br/>")
})
regions_nz_summary$popup_content <- paste0(
  "<b>Region: </b>", regions_nz_summary$Name, "<br>",
  "<b>Species richness: </b>", regions_nz_summary$species_richness, "<br>",
  "<b>Species counts:</b><br>", regions_nz_summary$species_popup
)
caption_point <- st_sf(
  label = "Data source: Travis Dawson via Kaggle https://www.kaggle.com/datasets/travisdaws/spatiotemporal-wildlife-dataset/data",
  geometry = st_sfc(st_point(c(mean(st_coordinates(regions_nz)[,1]), min(st_coordinates(regions_nz)[,2]) - 1))),
  crs = st_crs(regions_nz)
)
tmap_mode("view")
tm_shape(regions_nz_summary) +
  tm_polygons(
    col = "species_richness", 
    palette = "YlOrRd", 
    style = "quantile", 
    id = "popup_content",
    title = "Unique Species (Richness)",
    fill.legend = 
      tm_legend(
        title = "Number of Species",
        title.size = 1.2,
        text.size = 0.9,
        position = c("right", "bottom"),
        orientation = "vertical",
        bg.color = "white",
        bg.alpha = 0.8,
        frame = TRUE)) +
  tm_shape(caption_point) +
  tm_text("label", size = 0.7, col = "black", html=TRUE) +
tm_view()
```
# Conclusion
I think this looks fantastic. It's got interactivity which I never thought I could achieve in R, and it presents the desired information in a really concise way. My only regret is that the "click" popups are haunting me like ghosts. I can get the "hover" ones to display the information I want in a well formatted way, but if you click on a region, the window that comes up is unruly, and the HTML formatting code doesn't work right. I think this might be a limitation of tmap as I know that leaflet is designed to give more HTML-compatible customization.